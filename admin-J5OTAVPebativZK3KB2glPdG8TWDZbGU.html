<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piaf ‚Äî Tableau de bord</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --noir: #1a1a1a;
            --blanc: #faf9f7;
            --creme: #f5f3ef;
            --or: #c9a959;
            --or-clair: #e8d9a8;
            --bordeaux: #722f37;
            --vert: #2d5a3d;
            --orange: #d4763a;
            --gris: #6b6b6b;
            --gris-clair: #e0ddd8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--creme);
            color: var(--noir);
            min-height: 100vh;
        }

        header {
            background: var(--noir);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-family: 'Playfair Display', serif;
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--blanc);
            letter-spacing: 0.1em;
        }

        .logo span { color: var(--or); }

        .header-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-date {
            color: var(--gris-clair);
            font-size: 0.9rem;
        }

        .refresh-btn {
            background: var(--or);
            color: var(--noir);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .refresh-btn:hover { background: #b8954d; }
        
        .refresh-btn.loading {
            opacity: 0.7;
            cursor: wait;
        }

        .container {
            display: grid;
            grid-template-columns: 280px 1fr 340px;
            min-height: calc(100vh - 60px);
        }

        .sidebar-left {
            background: var(--blanc);
            border-right: 1px solid var(--gris-clair);
            padding: 1.5rem;
        }

        .section-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--noir);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-title::before {
            content: '';
            width: 3px;
            height: 1.2rem;
            background: var(--or);
        }

        .calendar {
            background: var(--creme);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .calendar-month {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .calendar-nav {
            display: flex;
            gap: 0.5rem;
        }

        .calendar-nav button {
            background: var(--blanc);
            border: 1px solid var(--gris-clair);
            width: 28px;
            height: 28px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .calendar-nav button:hover {
            background: var(--or);
            border-color: var(--or);
            color: var(--blanc);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            text-align: center;
        }

        .calendar-day-name {
            font-size: 0.7rem;
            color: var(--gris);
            padding: 0.25rem;
            font-weight: 500;
        }

        .calendar-day {
            padding: 0.4rem;
            font-size: 0.85rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-day:hover { background: var(--or-clair); }
        .calendar-day.today { background: var(--or); color: var(--blanc); font-weight: 600; }
        .calendar-day.selected { background: var(--noir); color: var(--blanc); }
        .calendar-day.closed { color: var(--gris-clair); cursor: not-allowed; }
        .calendar-day.has-reservations::after {
            content: '';
            display: block;
            width: 4px;
            height: 4px;
            background: var(--bordeaux);
            border-radius: 50%;
            margin: 2px auto 0;
        }

        .quick-stats {
            display: grid;
            gap: 0.75rem;
        }

        .stat-card {
            background: var(--creme);
            padding: 1rem;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-label { font-size: 0.85rem; color: var(--gris); }
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'Playfair Display', serif;
        }
        .stat-value.pending { color: var(--orange); }
        .stat-value.confirmed { color: var(--vert); }

        .main-content {
            padding: 1.5rem 2rem;
            overflow-y: auto;
        }

        .date-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .current-date {
            font-family: 'Playfair Display', serif;
            font-size: 1.75rem;
            font-weight: 600;
        }

        .tables-overview { margin-top: 2rem; }

        .tables-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            background: var(--blanc);
            padding: 1.5rem;
            border-radius: 12px;
        }

        .table-item {
            aspect-ratio: 1;
            background: var(--creme);
            border: 2px solid var(--gris-clair);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .table-item.available { border-color: var(--vert); background: rgba(45, 90, 61, 0.1); }
        .table-item.occupied { border-color: var(--bordeaux); background: rgba(114, 47, 55, 0.1); }

        .table-number {
            font-weight: 700;
            font-size: 1.25rem;
            font-family: 'Playfair Display', serif;
        }

        .table-status {
            font-size: 0.7rem;
            color: var(--gris);
            margin-top: 0.25rem;
        }

        .sidebar-right {
            background: var(--blanc);
            border-left: 1px solid var(--gris-clair);
            padding: 1.5rem;
            overflow-y: auto;
        }

        .pending-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .reservation-card {
            background: var(--creme);
            border-radius: 10px;
            padding: 1rem;
            border-left: 4px solid var(--orange);
            transition: all 0.2s;
            animation: fadeIn 0.3s ease-out;
        }

        .reservation-card:hover { transform: translateX(4px); }
        .reservation-card.confirmed { border-left-color: var(--vert); }
        .reservation-card.refused { border-left-color: var(--bordeaux); opacity: 0.6; }

        .reservation-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .reservation-name { font-weight: 600; font-size: 1rem; }

        .reservation-guests {
            background: var(--noir);
            color: var(--blanc);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .reservation-details {
            font-size: 0.85rem;
            color: var(--gris);
            margin-bottom: 0.75rem;
        }

        .reservation-details span { display: block; margin-bottom: 0.25rem; }
        .reservation-time { font-weight: 600; color: var(--noir); }
        .reservation-tables { font-size: 0.75rem; color: var(--gris); margin-bottom: 0.75rem; }

        .reservation-actions { display: flex; gap: 0.5rem; }

        .btn {
            flex: 1;
            padding: 0.6rem 0.75rem;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-confirm { background: var(--vert); color: var(--blanc); }
        .btn-confirm:hover { background: #234a31; }
        .btn-refuse { background: var(--blanc); color: var(--bordeaux); border: 1px solid var(--bordeaux); }
        .btn-refuse:hover { background: var(--bordeaux); color: var(--blanc); }

        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active { opacity: 1; visibility: visible; }

        .modal {
            background: var(--blanc);
            border-radius: 12px;
            padding: 2rem;
            max-width: 450px;
            width: 90%;
            transform: translateY(20px);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal { transform: translateY(0); }

        .modal-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .modal-subtitle { color: var(--gris); margin-bottom: 1.5rem; }

        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.5rem; }

        .form-group textarea, .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gris-clair);
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.9rem;
        }

        .form-group textarea { resize: vertical; min-height: 100px; }
        .form-group textarea:focus, .form-group input:focus { outline: none; border-color: var(--or); }

        .modal-actions { display: flex; gap: 0.75rem; margin-top: 1.5rem; }
        .btn-cancel { background: var(--creme); color: var(--noir); }
        .btn-send { background: var(--bordeaux); color: var(--blanc); }
        .btn-add { background: var(--or); color: var(--noir); }

        .closures-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--gris-clair);
        }

        .closure-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--creme);
            border-radius: 6px;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }

        .closure-delete {
            background: none;
            border: none;
            color: var(--bordeaux);
            cursor: pointer;
            font-size: 1rem;
        }

        .add-closure-btn {
            width: 100%;
            padding: 0.75rem;
            background: var(--blanc);
            border: 2px dashed var(--gris-clair);
            border-radius: 8px;
            color: var(--gris);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .add-closure-btn:hover { border-color: var(--or); color: var(--noir); }

        .empty-state { text-align: center; padding: 2rem; color: var(--gris); }
        .empty-state-icon { font-size: 2.5rem; margin-bottom: 0.75rem; opacity: 0.5; }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: var(--gris);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--gris-clair);
            border-top-color: var(--or);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 0.75rem;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--noir);
            color: var(--blanc);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            z-index: 2000;
            animation: fadeIn 0.3s ease-out;
        }

        .toast.success { background: var(--vert); }
        .toast.error { background: var(--bordeaux); }

        /* Debug panel */
        .debug-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1a1a1a;
            color: #00ff00;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            z-index: 9999;
            display: none;
        }
        
        .debug-panel.visible {
            display: block;
        }
        
        .debug-toggle {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: var(--bordeaux);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            z-index: 10000;
            font-size: 12px;
        }
        
        .debug-line {
            margin: 2px 0;
            border-bottom: 1px solid #333;
            padding: 2px 0;
        }
        
        .debug-line.error { color: #ff6b6b; }
        .debug-line.success { color: #69db7c; }
        .debug-line.info { color: #74c0fc; }

        /* Status indicator */
        .api-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.75rem;
            background: rgba(255,255,255,0.1);
            color: var(--gris-clair);
        }
        
        .api-status .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--gris);
        }
        
        .api-status.connected .dot { background: var(--vert); }
        .api-status.error .dot { background: var(--bordeaux); }
        .api-status.loading .dot { 
            background: var(--or);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        @media (max-width: 1200px) {
            .container { grid-template-columns: 1fr; }
            .sidebar-left, .sidebar-right { display: none; }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">PIAF<span>.</span> <small style="font-size: 0.6em; color: var(--gris-clair);">Admin</small></div>
        <div class="header-info">
            <div class="api-status" id="apiStatus">
                <span class="dot"></span>
                <span id="apiStatusText">Connexion...</span>
            </div>
            <div class="header-date" id="headerDate"></div>
            <button class="refresh-btn" id="refreshBtn" onclick="loadDashboard()">‚Üª Actualiser</button>
        </div>
    </header>

    <div class="container">
        <aside class="sidebar-left">
            <h2 class="section-title">Calendrier</h2>
            <div class="calendar">
                <div class="calendar-header">
                    <span class="calendar-month" id="calendarMonth"></span>
                    <div class="calendar-nav">
                        <button onclick="changeMonth(-1)">‚Äπ</button>
                        <button onclick="changeMonth(1)">‚Ä∫</button>
                    </div>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>

            <h2 class="section-title">Aujourd'hui</h2>
            <div class="quick-stats">
                <div class="stat-card">
                    <span class="stat-label">En attente</span>
                    <span class="stat-value pending" id="statPending">-</span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Confirm√©es</span>
                    <span class="stat-value confirmed" id="statConfirmed">-</span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Couverts</span>
                    <span class="stat-value" id="statGuests">-</span>
                </div>
            </div>

            <div class="closures-section">
                <h2 class="section-title">Fermetures</h2>
                <div id="closuresList"></div>
                <button class="add-closure-btn" onclick="openClosureModal()">+ Ajouter une fermeture</button>
            </div>
        </aside>

        <main class="main-content">
            <div class="date-header">
                <h1 class="current-date" id="currentDateTitle"></h1>
                <button class="refresh-btn" onclick="loadAllReservations()" style="background: var(--bordeaux);">
                    üìã Voir TOUTES les r√©servations
                </button>
            </div>

            <div class="tables-overview">
                <h2 class="section-title">√âtat des tables</h2>
                <div class="tables-grid" id="tablesGrid">
                    <!-- G√©n√©r√© par JS -->
                </div>
            </div>

            <div style="margin-top: 2rem;">
                <h2 class="section-title">Toutes les r√©servations du jour</h2>
                <div id="allReservations" class="pending-list"></div>
            </div>
        </main>

        <aside class="sidebar-right">
            <h2 class="section-title">Demandes en attente</h2>
            <div class="pending-list" id="pendingList">
                <div class="loading">
                    <div class="spinner"></div>
                    Chargement...
                </div>
            </div>

            <h2 class="section-title" style="margin-top: 2rem;">Confirm√©es aujourd'hui</h2>
            <div class="pending-list" id="confirmedList"></div>
        </aside>
    </div>

    <!-- Modal Refus -->
    <div class="modal-overlay" id="refuseModal">
        <div class="modal">
            <h2 class="modal-title">Refuser la r√©servation</h2>
            <p class="modal-subtitle" id="refuseModalSubtitle"></p>
            <div class="form-group">
                <label>Message au client</label>
                <textarea id="refuseMessage" placeholder="Ex: Nous sommes d√©sol√©s, mais nous sommes complets..."></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="closeModal('refuseModal')">Annuler</button>
                <button class="btn btn-send" onclick="confirmRefuse()">Envoyer le refus</button>
            </div>
        </div>
    </div>

    <!-- Modal Fermeture -->
    <div class="modal-overlay" id="closureModal">
        <div class="modal">
            <h2 class="modal-title">Ajouter une fermeture</h2>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="closureDate">
            </div>
            <div class="form-group">
                <label>Heure de d√©but</label>
                <input type="time" id="closureStart" value="12:00">
            </div>
            <div class="form-group">
                <label>Heure de fin</label>
                <input type="time" id="closureEnd" value="14:30">
            </div>
            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="closeModal('closureModal')">Annuler</button>
                <button class="btn btn-add" onclick="addClosure()">Ajouter</button>
            </div>
        </div>
    </div>

    <!-- Debug Panel -->
    <button class="debug-toggle" onclick="toggleDebug()">üîß Debug</button>
    <div class="debug-panel" id="debugPanel"></div>

    <script>
        // ============================================
        // CONFIGURATION - √Ä MODIFIER
        // ============================================
        
        // ‚ö†Ô∏è REMPLACEZ ces valeurs apr√®s avoir d√©ploy√© Google Apps Script
        const API_URL = 'https://script.google.com/macros/s/AKfycbyUUgPykQFHKBgyeKG2L5aQtbihyAUS7WQ3QSeJIMm5kKzLqkLxzil5bJscal08rjIz/exec';
        const ADMIN_SECRET = 'J5OTAVPebativZK3KB2glPdG8TWDZbGU';
        
        // Mode test activ√© si l'URL n'est pas configur√©e
        const TEST_MODE = API_URL.includes('VOTRE_ID');
        
        // ============================================
        // DEBUG
        // ============================================
        
        const debugLogs = [];
        
        function debugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = { timestamp, message, type };
            debugLogs.push(logEntry);
            
            // Console
            const consoleMethod = type === 'error' ? console.error : (type === 'success' ? console.log : console.info);
            consoleMethod(`[${timestamp}] ${message}`);
            
            // Panel
            updateDebugPanel();
        }
        
        function updateDebugPanel() {
            const panel = document.getElementById('debugPanel');
            panel.innerHTML = debugLogs.slice(-50).map(log => 
                `<div class="debug-line ${log.type}">[${log.timestamp}] ${log.message}</div>`
            ).join('');
            panel.scrollTop = panel.scrollHeight;
        }
        
        function toggleDebug() {
            document.getElementById('debugPanel').classList.toggle('visible');
        }
        
        function setApiStatus(status, text) {
            const el = document.getElementById('apiStatus');
            const textEl = document.getElementById('apiStatusText');
            el.className = 'api-status ' + status;
            textEl.textContent = text;
        }
        
        // ============================================
        // √âTAT
        // ============================================
        
        let state = {
            selectedDate: new Date().toISOString().split('T')[0],
            currentMonth: new Date(),
            reservations: [],
            closures: [],
            pendingRefuseId: null
        };

        const DAYS = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
        const MONTHS = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 
                        'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];

        // ============================================
        // INITIALISATION
        // ============================================
        
        document.addEventListener('DOMContentLoaded', () => {
            debugLog('Dashboard initialis√©', 'info');
            debugLog(`API URL: ${API_URL.substring(0, 50)}...`, 'info');
            debugLog(`Date s√©lectionn√©e: ${state.selectedDate}`, 'info');
            debugLog(`Mode test: ${TEST_MODE}`, TEST_MODE ? 'error' : 'success');
            
            updateHeaderDate();
            renderCalendar();
            loadDashboard();
            loadClosures();
            
            // Auto-refresh toutes les 30 secondes
            setInterval(() => {
                debugLog('Auto-refresh...', 'info');
                loadDashboard();
            }, 30000);
        });

        // ============================================
        // API
        // ============================================
        
        // Donn√©es de d√©monstration pour le mode test
        const DEMO_DATA = {
            reservations: [
                { id: 'RES-DEMO1', date: new Date().toISOString().split('T')[0], heure: '12:30', personnes: 4, nom: 'Sophie Dubois', telephone: '+32 475 12 34 56', email: 'sophie@test.be', langue: 'fr', statut: 'en attente', tables: '4' },
                { id: 'RES-DEMO2', date: new Date().toISOString().split('T')[0], heure: '19:00', personnes: 6, nom: 'Van den Berg', telephone: '+32 486 98 76 54', email: 'vdberg@test.nl', langue: 'nl', statut: 'en attente', tables: '1, 2' },
                { id: 'RES-DEMO3', date: new Date().toISOString().split('T')[0], heure: '12:00', personnes: 3, nom: 'Marc Dupont', telephone: '+32 470 11 22 33', email: 'marc@test.be', langue: 'fr', statut: 'confirm√©e', tables: '2' },
                { id: 'RES-DEMO4', date: new Date().toISOString().split('T')[0], heure: '12:15', personnes: 2, nom: 'Emma Martin', telephone: '+32 480 44 55 66', email: 'emma@test.be', langue: 'fr', statut: 'confirm√©e', tables: '3' }
            ],
            closures: []
        };
        
        async function apiCall(action, params = {}, postData = null) {
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.classList.add('loading');
            setApiStatus('loading', 'Requ√™te...');
            
            debugLog(`API Call: ${action} | Params: ${JSON.stringify(params)}`, 'info');
            
            // Mode test : retourne des donn√©es de d√©monstration
            if (TEST_MODE) {
                debugLog('MODE TEST - Utilisation de donn√©es de d√©monstration', 'error');
                await new Promise(r => setTimeout(r, 500));
                
                if (action === 'getDashboardData') {
                    const pending = DEMO_DATA.reservations.filter(r => r.statut === 'en attente').length;
                    const confirmed = DEMO_DATA.reservations.filter(r => r.statut === 'confirm√©e').length;
                    const totalGuests = DEMO_DATA.reservations.filter(r => r.statut === 'confirm√©e').reduce((sum, r) => sum + r.personnes, 0);
                    
                    return {
                        success: true,
                        date: params.date || new Date().toISOString().split('T')[0],
                        stats: { pending, confirmed, totalGuests },
                        reservations: DEMO_DATA.reservations,
                        closures: DEMO_DATA.closures
                    };
                }
                
                if (action === 'getClosures') {
                    return { success: true, closures: DEMO_DATA.closures };
                }
                
                if (action === 'confirmReservation') {
                    const res = DEMO_DATA.reservations.find(r => r.id === params.id);
                    if (res) res.statut = 'confirm√©e';
                    return { success: true };
                }
                
                if (action === 'refuseReservation') {
                    const res = DEMO_DATA.reservations.find(r => r.id === params.id);
                    if (res) res.statut = 'refus√©e';
                    return { success: true };
                }
                
                return { success: true };
            }
            
            // Mode production
            let url = `${API_URL}?action=${action}&secret=${ADMIN_SECRET}`;
            Object.keys(params).forEach(key => {
                url += `&${key}=${encodeURIComponent(params[key])}`;
            });
            
            debugLog(`URL compl√®te: ${url}`, 'info');
            
            const options = { 
                method: postData ? 'POST' : 'GET',
                redirect: 'follow'
            };
            
            if (postData) {
                options.headers = { 'Content-Type': 'text/plain' };
                options.body = JSON.stringify(postData);
                debugLog(`POST data: ${JSON.stringify(postData)}`, 'info');
            }
            
            try {
                debugLog('Envoi de la requ√™te...', 'info');
                const startTime = Date.now();
                
                const response = await fetch(url, options);
                
                const duration = Date.now() - startTime;
                debugLog(`R√©ponse re√ßue en ${duration}ms | Status: ${response.status}`, 
                    response.ok ? 'success' : 'error');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const text = await response.text();
                debugLog(`R√©ponse brute (${text.length} chars): ${text.substring(0, 200)}...`, 'info');
                
                let data;
                try {
                    data = JSON.parse(text);
                } catch (parseError) {
                    debugLog(`Erreur parsing JSON: ${parseError.message}`, 'error');
                    throw new Error('R√©ponse invalide du serveur');
                }
                
                debugLog(`Donn√©es pars√©es: success=${data.success}`, data.success ? 'success' : 'error');
                
                if (data.reservations) {
                    debugLog(`R√©servations re√ßues: ${data.reservations.length}`, 'info');
                    data.reservations.forEach((r, i) => {
                        debugLog(`  [${i}] ${r.id} | ${r.date} ${r.heure} | ${r.nom} | ${r.statut}`, 'info');
                    });
                }
                
                setApiStatus('connected', 'Connect√©');
                refreshBtn.classList.remove('loading');
                
                return data;
                
            } catch (error) {
                debugLog(`ERREUR: ${error.message}`, 'error');
                setApiStatus('error', 'Erreur');
                refreshBtn.classList.remove('loading');
                
                showToast('Erreur de connexion: ' + error.message, 'error');
                return { success: false, error: error.message };
            }
        }

        // ============================================
        // DASHBOARD
        // ============================================
        
        async function loadDashboard() {
            debugLog(`=== loadDashboard() | Date: ${state.selectedDate} ===`, 'info');
            
            const data = await apiCall('getDashboardData', { date: state.selectedDate });
            
            if (data.success) {
                state.reservations = data.reservations || [];
                
                debugLog(`R√©servations charg√©es: ${state.reservations.length}`, 'success');
                
                // Stats
                const pending = state.reservations.filter(r => r.statut === 'en attente').length;
                const confirmed = state.reservations.filter(r => r.statut === 'confirm√©e').length;
                
                debugLog(`Stats calcul√©es: pending=${pending}, confirmed=${confirmed}`, 'info');
                
                document.getElementById('statPending').textContent = data.stats?.pending || pending;
                document.getElementById('statConfirmed').textContent = data.stats?.confirmed || confirmed;
                document.getElementById('statGuests').textContent = data.stats?.totalGuests || 0;
                
                renderPendingList();
                renderConfirmedList();
                renderAllReservations();
                renderTables();
                updateDateTitle();
            } else {
                debugLog(`√âchec loadDashboard: ${data.error}`, 'error');
            }
        }
        
        async function loadAllReservations() {
            debugLog('=== loadAllReservations() ===', 'info');
            
            const data = await apiCall('getAllReservations', {});
            
            if (data.success && data.reservations) {
                debugLog(`Toutes les r√©servations: ${data.reservations.length}`, 'success');
                
                const container = document.getElementById('allReservations');
                
                if (data.reservations.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <p>Aucune r√©servation dans la base de donn√©es</p>
                        </div>
                    `;
                } else {
                    // Grouper par date
                    const byDate = {};
                    data.reservations.forEach(r => {
                        if (!byDate[r.date]) byDate[r.date] = [];
                        byDate[r.date].push(r);
                    });
                    
                    let html = '<div style="background: var(--or-clair); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">üìã Affichage de TOUTES les r√©servations (toutes dates)</div>';
                    
                    Object.keys(byDate).sort().reverse().forEach(date => {
                        html += `<h3 style="margin: 1rem 0 0.5rem; color: var(--bordeaux);">üìÖ ${date}</h3>`;
                        byDate[date].forEach(r => {
                            html += renderReservationCard(r, r.statut === 'en attente');
                        });
                    });
                    
                    container.innerHTML = html;
                }
            }
        }

        // ============================================
        // R√âSERVATIONS
        // ============================================
        
        function renderPendingList() {
            const container = document.getElementById('pendingList');
            const pending = state.reservations.filter(r => r.statut === 'en attente');
            
            debugLog(`renderPendingList: ${pending.length} en attente`, 'info');
            
            if (pending.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚úì</div>
                        <p>Aucune demande en attente</p>
                        <p style="font-size: 0.8rem; margin-top: 0.5rem;">pour le ${state.selectedDate}</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = pending.map(r => renderReservationCard(r, true)).join('');
        }

        function renderConfirmedList() {
            const container = document.getElementById('confirmedList');
            const confirmed = state.reservations.filter(r => r.statut === 'confirm√©e');
            
            debugLog(`renderConfirmedList: ${confirmed.length} confirm√©es`, 'info');
            
            if (confirmed.length === 0) {
                container.innerHTML = `<p style="color: var(--gris); text-align: center;">Aucune r√©servation confirm√©e</p>`;
                return;
            }
            
            container.innerHTML = confirmed.map(r => renderReservationCard(r, false)).join('');
        }

        function renderAllReservations() {
            const container = document.getElementById('allReservations');
            const sorted = [...state.reservations].sort((a, b) => a.heure.localeCompare(b.heure));
            
            debugLog(`renderAllReservations: ${sorted.length} total`, 'info');
            
            if (sorted.length === 0) {
                container.innerHTML = `<p style="color: var(--gris);">Aucune r√©servation pour le ${state.selectedDate}</p>`;
                return;
            }
            
            container.innerHTML = sorted.map(r => renderReservationCard(r, r.statut === 'en attente')).join('');
        }

        function renderReservationCard(r, showActions) {
            const statusClass = r.statut === 'confirm√©e' ? 'confirmed' : (r.statut === 'refus√©e' ? 'refused' : '');
            
            return `
                <div class="reservation-card ${statusClass}" data-id="${r.id}">
                    <div class="reservation-header">
                        <span class="reservation-name">${escapeHtml(r.nom)}</span>
                        <span class="reservation-guests">${r.personnes} pers.</span>
                    </div>
                    <div class="reservation-details">
                        <span class="reservation-time">üìÖ ${r.date} √† ${r.heure}</span>
                        <span>üìû ${escapeHtml(r.telephone)}</span>
                        <span>‚úâÔ∏è ${escapeHtml(r.email)}</span>
                        <span style="font-size: 0.75rem; color: var(--or);">üîñ ${r.statut} | ID: ${r.id}</span>
                    </div>
                    ${r.tables ? `<div class="reservation-tables">Tables : ${r.tables}</div>` : ''}
                    ${showActions ? `
                        <div class="reservation-actions">
                            <button class="btn btn-confirm" onclick="confirmReservation('${r.id}')">‚úì Confirmer</button>
                            <button class="btn btn-refuse" onclick="openRefuseModal('${r.id}', '${escapeHtml(r.nom)}')">‚úó Refuser</button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        async function confirmReservation(id) {
            debugLog(`confirmReservation: ${id}`, 'info');
            const result = await apiCall('confirmReservation', { id });
            
            if (result.success) {
                showToast('R√©servation confirm√©e !', 'success');
                loadDashboard();
            } else {
                showToast('Erreur: ' + result.error, 'error');
            }
        }

        function openRefuseModal(id, name) {
            state.pendingRefuseId = id;
            document.getElementById('refuseModalSubtitle').textContent = 
                `Un email sera envoy√© √† ${name} avec votre message.`;
            document.getElementById('refuseMessage').value = '';
            document.getElementById('refuseModal').classList.add('active');
        }

        async function confirmRefuse() {
            const message = document.getElementById('refuseMessage').value;
            debugLog(`confirmRefuse: ${state.pendingRefuseId}`, 'info');
            
            const result = await apiCall('refuseReservation', 
                { id: state.pendingRefuseId }, 
                { message }
            );
            
            closeModal('refuseModal');
            
            if (result.success) {
                showToast('R√©servation refus√©e', 'success');
                loadDashboard();
            } else {
                showToast('Erreur: ' + result.error, 'error');
            }
        }

        // ============================================
        // TABLES
        // ============================================
        
        function renderTables() {
            const container = document.getElementById('tablesGrid');
            const occupiedTables = new Set();
            
            // Trouver les tables occup√©es
            state.reservations
                .filter(r => r.statut === 'confirm√©e' && r.tables)
                .forEach(r => {
                    String(r.tables).split(',').forEach(t => occupiedTables.add(parseInt(t.trim())));
                });
            
            let html = '';
            for (let i = 1; i <= 8; i++) {
                const isOccupied = occupiedTables.has(i);
                const reservation = state.reservations.find(r => 
                    r.statut === 'confirm√©e' && r.tables && r.tables.includes(i.toString())
                );
                
                html += `
                    <div class="table-item ${isOccupied ? 'occupied' : 'available'}">
                        <span class="table-number">${i}</span>
                        <span class="table-status">${isOccupied ? (reservation?.nom || 'Occup√©e') : 'Libre'}</span>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        // ============================================
        // FERMETURES
        // ============================================
        
        async function loadClosures() {
            debugLog('loadClosures()', 'info');
            const result = await apiCall('getClosures');
            if (result.success) {
                state.closures = result.closures || [];
                debugLog(`Fermetures: ${state.closures.length}`, 'info');
                renderClosures();
            }
        }

        function renderClosures() {
            const container = document.getElementById('closuresList');
            
            // Filtrer les fermetures futures
            const today = new Date().toISOString().split('T')[0];
            const futurClosures = state.closures.filter(c => c.date >= today);
            
            if (futurClosures.length === 0) {
                container.innerHTML = '<p style="color: var(--gris); font-size: 0.85rem;">Aucune fermeture programm√©e</p>';
                return;
            }
            
            container.innerHTML = futurClosures.map(c => `
                <div class="closure-item">
                    <span>${c.date} ${c.start}-${c.end}</span>
                    <button class="closure-delete" onclick="deleteClosure('${c.id}')">√ó</button>
                </div>
            `).join('');
        }

        function openClosureModal() {
            document.getElementById('closureDate').value = state.selectedDate;
            document.getElementById('closureModal').classList.add('active');
        }

        async function addClosure() {
            const date = document.getElementById('closureDate').value;
            const start = document.getElementById('closureStart').value;
            const end = document.getElementById('closureEnd').value;
            
            debugLog(`addClosure: ${date} ${start}-${end}`, 'info');
            
            const result = await apiCall('addClosure', {}, { date, startTime: start, endTime: end });
            
            closeModal('closureModal');
            
            if (result.success) {
                showToast('Fermeture ajout√©e', 'success');
                loadClosures();
            } else {
                showToast('Erreur: ' + result.error, 'error');
            }
        }

        async function deleteClosure(id) {
            debugLog(`deleteClosure: ${id}`, 'info');
            const result = await apiCall('removeClosure', { id });
            
            if (result.success) {
                showToast('Fermeture supprim√©e', 'success');
                loadClosures();
            } else {
                showToast('Erreur: ' + result.error, 'error');
            }
        }

        // ============================================
        // CALENDRIER
        // ============================================
        
        function renderCalendar() {
            const year = state.currentMonth.getFullYear();
            const month = state.currentMonth.getMonth();
            
            document.getElementById('calendarMonth').textContent = `${MONTHS[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDay = firstDay.getDay();
            
            let html = DAYS.map(d => `<div class="calendar-day-name">${d}</div>`).join('');
            
            // Jours vides avant
            for (let i = 0; i < startDay; i++) {
                html += '<div class="calendar-day"></div>';
            }
            
            // Jours du mois
            const today = new Date().toISOString().split('T')[0];
            
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayOfWeek = new Date(year, month, day).getDay();
                const isClosed = dayOfWeek === 1 || dayOfWeek === 2; // Lundi, Mardi
                
                let classes = 'calendar-day';
                if (dateStr === today) classes += ' today';
                if (dateStr === state.selectedDate) classes += ' selected';
                if (isClosed) classes += ' closed';
                
                html += `<div class="${classes}" onclick="selectDate('${dateStr}')">${day}</div>`;
            }
            
            document.getElementById('calendarGrid').innerHTML = html;
        }

        function changeMonth(delta) {
            state.currentMonth.setMonth(state.currentMonth.getMonth() + delta);
            renderCalendar();
        }

        function selectDate(dateStr) {
            debugLog(`selectDate: ${dateStr}`, 'info');
            state.selectedDate = dateStr;
            renderCalendar();
            loadDashboard();
        }

        // ============================================
        // UI HELPERS
        // ============================================
        
        function updateHeaderDate() {
            const now = new Date();
            document.getElementById('headerDate').textContent = 
                `${DAYS[now.getDay()]} ${now.getDate()} ${MONTHS[now.getMonth()]} ${now.getFullYear()}`;
        }

        function updateDateTitle() {
            const date = new Date(state.selectedDate);
            document.getElementById('currentDateTitle').textContent = 
                `${DAYS[date.getDay()]} ${date.getDate()} ${MONTHS[date.getMonth()]}`;
        }

        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/[&<>"']/g, m => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            }[m]));
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function showToast(message, type = 'info') {
            debugLog(`Toast: ${message}`, type);
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }

        // Fermer modals au clic ext√©rieur
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', e => {
                if (e.target === modal) closeModal(modal.id);
            });
        });
    </script>
</body>
</html>
